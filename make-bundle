#!/bin/bash
#===============================================================================
#
#          FILE:  make-bundle
#
#         USAGE:  ./make-bundle
#
#   DESCRIPTION:  Makes T-Mobile US carrier bundles.
#
#        AUTHOR:  SpookyET, spookyet@gmail.com
#       VERSION:  1.0.2
#       CREATED:  2009-06-30 23:34:57+00:00
#===============================================================================

CURRENT_BRANCH=`git branch | grep '^\*' |  sed -e 's/* //'`
VERSION=`git tag | tail -n 1`
PACKAGE_VERSION=1
PACKAGE="t-mobile-us-carrier-support_$VERSION"
for BRANCH in `git branch | sed -e 's/* //'`
do
	if [[ $BRANCH =~ 'master' ]]
	then
		continue
	fi
	git checkout $BRANCH &> /dev/null
	if [[ $? -ne 0 ]]
	then
		echo "ERROR: Cannot change branch."
		exit 1
	fi
	find . -type f -name '.DS_Store' -exec rm {} \;
	BUNDLE_NAME="t-mobile-us-${BRANCH}.ipcc"
	echo Making carrier bundle $BUNDLE_NAME
	rm -rf $BUNDLE_NAME 
	zip -r -y "$BUNDLE_NAME" Payload/ &> /dev/null

	PACKAGE_NAME="t-mobile-us-carrier-support-$( echo $BRANCH | sed -e 's/_/-/' )_${VERSION}-${PACKAGE_VERSION}_iphoneos-arm"
	echo Making Cydia/Icy package $PACKAGE_NAME
	mkdir $PACKAGE_NAME 
	mkdir -p ${PACKAGE_NAME}/DEBIAN
	mkdir -p ${PACKAGE_NAME}/System/Library/Carrier\ Bundles/
	cp -r debian/* ${PACKAGE_NAME}/DEBIAN
	cp -r Payload/* ${PACKAGE_NAME}/System/Library/Carrier\ Bundles/
	dpkg -b $PACKAGE_NAME ${PACKAGE_NAME}.deb &> /dev/null
	rm -rf ${PACKAGE_NAME}
done
echo Making package ${PACKAGE}.ipcc.zip
zip ${PACKAGE}.ipcc.zip README.txt t-mobile-us*.ipcc -x $PACKAGE &> /dev/null
echo Making package ${PACKAGE}.deb.zip
zip ${PACKAGE}.deb.zip t-mobile-us*.deb -x $PACKAGE &> /dev/null
rm -f *.ipcc *.deb
git checkout $CURRENT_BRANCH &> /dev/null
