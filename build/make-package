#!/bin/bash
#===============================================================================
#
#          FILE:  make-package
#
#         USAGE:  ./make-package
#
#   DESCRIPTION:  Makes T-Mobile US carrier bundles.
#
#        AUTHOR:  Sorin Ionescu <sorin.ionescu@gmail.com>
#       VERSION:  1.0.7
#       CREATED:  2010-06-20 21:36:14-04:00
#===============================================================================

VERSION=`git tag | grep "^1\.0" | sort -n -k3 -t. | tail -n 1`

IPCC_PACKAGE_VERSION=1
IPCC_PACKAGE_PREFIX="t-mobile_us"

DEB_PACKAGE_VERSION=1
DEB_PACKAGE_PREFIX="tmobileus"

cd $( dirname $0 )

for folder in ../src/*
do
	if [[ $folder =~ 'template' ]]
	then
		continue
	fi
	
	find . -type f -name '.DS_Store' -exec rm {} \;
	bundle_name=$(echo $folder | sed -e 's/..\/src\///')
	
	# IPCC
	bundle_file_name="t-mobile_us_${bundle_name}.ipcc"
	echo Making carrier bundle $bundle_file_name
	rm -rf $bundle_file_name Payload
	mkdir -p Payload/TMobile_us.bundle
	cp -L $folder/* Payload/TMobile_us.bundle/ &> /dev/null
	find Payload/TMobile_us.bundle/ -type f -name "*.plist" -exec plutil -convert binary1 {} \;
	ln -s TMobile_us.bundle Payload/310260
	zip -r -y "$bundle_file_name" Payload/ &> /dev/null
	rm -rf Payload

	# DEB
	bundle_name=$(echo $bundle_name | sed -e 's/_//g')
	bundle_file_name="${DEB_PACKAGE_PREFIX}${bundle_name}${VERSION}.${DEB_PACKAGE_VERSION}"
	echo Making Cydia package $bundle_file_name.deb
	mkdir $bundle_file_name 
	mkdir -p ${bundle_file_name}/DEBIAN
	mkdir -p ${bundle_file_name}/System/Library/Carrier\ Bundles/TMobile_us.bundle
	cp -r $folder/debian/* ${bundle_file_name}/DEBIAN
	cp -L $folder/* ${bundle_file_name}/System/Library/Carrier\ Bundles/TMobile_us.bundle &> /dev/null
	find ${bundle_file_name}/System/Library/Carrier\ Bundles/TMobile_us.bundle -type f -name "*.plist" -exec plutil -convert binary1 {} \;
	ln -s TMobile_us.bundle ${bundle_file_name}/System/Library/Carrier\ Bundles/310260
	dpkg -b $bundle_file_name ${bundle_file_name}.deb &> /dev/null
done

rm -f *.zip

ipcc_package_name=${IPCC_PACKAGE_PREFIX}_${VERSION}.ipcc.zip
echo Making package $ipcc_package_name
cp ../doc/README .
zip -r $ipcc_package_name README *.ipcc &> /dev/null
rm -rf README *.ipcc

deb_package_name=${DEB_PACKAGE_PREFIX}${VERSION}.${DEB_PACKAGE_VERSION}.deb.zip
echo Making package $deb_package_name
zip $deb_package_name *.deb &> /dev/null
rm -rf *.deb

deb_extracted_package_name=${deb_package_name}.deb-extracted.zip
extracted_debs=$( find . -depth 1 -type d -name 'tmobileus*' )
echo Making package $deb_extracted_package_name
zip -r -y $deb_extracted_package_name $extracted_debs &> /dev/null
rm -rf $extracted_debs
